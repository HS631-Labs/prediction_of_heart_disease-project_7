---
title: "Heart Disease"
author: "Shannon Walsh"
date: "11/1/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Chunk 1: #Libraries 
```{r}
library(plotly)
library(stats)
library(tidyr)
library(ggplot2)
library(dplyr)
library(data.table)
library(tidyverse)
library(pastecs)
library(dbplyr)
library(Hmisc)
library(scales)
library(ROSE)
library(corrplot)
library(pscl)
library(DT)
library(caret)
library(varImp)
library(gridBase)
library(gridExtra)
```

#Chunk 2: Working directory 
```{r}
getwd()
```

#Chunk 3: Read in the data 
```{r}
heart_dataframe <- read.csv("./data/heart.csv")
head(heart_dataframe)
str(heart_dataframe)
```


#Chunk 4: Check NAs and for select variable check for missing/invalid data 
Missing data checked for variables Age, RestingBP, Cholesterol and MaxHR, as these are the variables where a value zero is not valid. Missing/Zero values replaced by NA
```{r}
colSums(is.na(heart_dataframe))

invalid_Age <- heart_dataframe$Age == 0
heart_dataframe$Age[invalid_Age] <- NA

invalid_RestingBP<- heart_dataframe$RestingBP == 0
heart_dataframe$RestingBP[invalid_RestingBP] <- 132.5

#As variable cholesterol has large number(172) of invalid values. Replace zero values with random values between 1st Quartile and mean. 
invalid_Cholesterol <- heart_dataframe$Cholesterol == 0
heart_dataframe$Cholesterol[invalid_Cholesterol]<- runif(172, min = 173.2, max = 198.8)

invalid_MaxHR <- heart_dataframe$MaxHR == 0
heart_dataframe$MaxHR[invalid_MaxHR] <- NA

nrow(heart_dataframe)
#na.omit(heart_dataframe)
colSums(is.na(heart_dataframe))
summary(heart_dataframe)
table(heart_dataframe$Cholesterol)
head(heart_dataframe, 50)
```

#Chunk 5: DataType Conversion. Applicable variables to factors 
```{r}
#sex
heart_dataframe$Sex[heart_dataframe$Sex == "F"] <- "Female"
heart_dataframe$Sex[heart_dataframe$Sex == "M"] <- "Male"
heart_dataframe$Sex <- as.factor(heart_dataframe$Sex)


#ChestPainType
heart_dataframe$ChestPainType[heart_dataframe$ChestPainType == "TA"] <- "Typical angina"
heart_dataframe$ChestPainType[heart_dataframe$ChestPainType == "ATA"] <- "Atypical angina"
heart_dataframe$ChestPainType[heart_dataframe$ChestPainType == "NAP"] <- "Non-anginal pain"
heart_dataframe$ChestPainType[heart_dataframe$ChestPainType == "ASY"] <- "Asymptomatic angina"
heart_dataframe$ChestPainType <- as.factor(heart_dataframe$ChestPainType)


#FastingBS 
heart_dataframe$FastingBS[heart_dataframe$FastingBS == 0] <- "Low  (<120 mg/dl)"
heart_dataframe$FastingBS[heart_dataframe$FastingBS == 1] <- "High (>120 mg/dl)"
heart_dataframe$FastingBS <- as.factor(heart_dataframe$FastingBS)

#RestingECG
heart_dataframe$RestingECG[heart_dataframe$RestingECG == "Normal"] <- "0 (normal)"
heart_dataframe$RestingECG[heart_dataframe$RestingECG == "ST"] <- "1 (ST)"
heart_dataframe$RestingECG[heart_dataframe$RestingECG == "LVH"] <- "2 (LVH)"
heart_dataframe$RestingECG <- as.factor(heart_dataframe$RestingECG)

#Exercise induced angina
heart_dataframe$ExerciseAngina[heart_dataframe$ExerciseAngina == "N"] <- "No"
heart_dataframe$ExerciseAngina[heart_dataframe$ExerciseAngina == "Y"] <- "Yes"
heart_dataframe$ExerciseAngina <- as.factor(heart_dataframe$ExerciseAngina)

#ST Slope
heart_dataframe$ST_Slope <- as.factor(heart_dataframe$ST_Slop)

#Heart Disease
heart_dataframe$HeartDisease[heart_dataframe$HeartDisease == "0"] <- "Health"
heart_dataframe$HeartDisease[heart_dataframe$HeartDisease == "1"] <- "Heart Disease"
heart_dataframe$HeartDisease <- as.factor(heart_dataframe$HeartDisease)

head(heart_dataframe,20)
summary(heart_dataframe)
str(heart_dataframe)
```
#Chunk 6: Characterizing distributions of NUMERIC variables and correcting for skew
```{r}
#Histograms for continuous integer/dbl variables 

#AGE
qqplot_Age<- qplot(sample = heart_dataframe$Age)+
xlab("Age in years")+
ylab("count")
qqplot_Age
#qqplot o/p indicates age of subjects are normally distributed.

age_distribution <- ggplot(heart_dataframe, aes( x= heart_dataframe$Age, fill = heart_dataframe$Age, na.rm = TRUE))+
  geom_histogram(color = "Black", fill = "Chocolate")+
  xlab("Age in years")+
  ylab("count")+
  ggtitle("Distribution of Age in database")
age_distribution 
#Age of majority of subjects falls between 50-60years. Plot shows a very slight negative skew. 

describe (heart_dataframe$Age)
stat.desc(heart_dataframe$Age, basic = FALSE, norm = TRUE)
shapiro.test(heart_dataframe$Age) #confirms data is not normally distributed 

#Correct for moderate negative new using sqrt 
sq_age <- sqrt((max(heart_dataframe$Age)+1) - heart_dataframe$Age) 
sq_age
sq_age_hist <- hist(sq_age)

#CHOLESTEROL 
cholesterol_distribution <- ggplot(heart_dataframe, aes( x= heart_dataframe$Cholesterol, fill = heart_dataframe$Cholesterol, na.rm = TRUE))+
  geom_histogram(color = "Black", fill = "Chocolate")+
  xlab("Serum Cholesterol Levels in mg/dl")+
  ylab("count")+
  ggtitle("Distribution of Serum Cholesterol Levels across database")
cholesterol_distribution 

qqplot_cholesterol<- qplot(sample = heart_dataframe$Cholesterol, na.rm = TRUE)+
xlab("Serum Cholesterol Levels in mg/dl")+
ylab("count")
qqplot_cholesterol

describe(heart_dataframe$Cholesterol)
stat.desc(heart_dataframe$Cholesterol, basic = FALSE, norm = TRUE)
shapiro.test(heart_dataframe$Cholesterol)
#Based on qqplot, descriptive statistics and histogram, Cholesterol Levels appears to be NOT normally distributed, has a positive skew. Kurtosis of 4.6 (>3) indicates data is leptokurtic.

#log transformation to correct positive skew 
log_cholesterol <- log(heart_dataframe$Cholesterol)
log_Chol_hist <- hist(log_cholesterol, main = "Distribution of Serum Cholestrol Levels in mg/dl")


#RESTING BLOOD PRESSURE 
BP_distribution <- ggplot(heart_dataframe, aes( x= heart_dataframe$RestingBP, fill = heart_dataframe$RestingBP, na.rm = TRUE))+
  geom_histogram(color = "Black", fill = "brown")+
  xlab("Blood Pressure is mmHg")+
  ylab("count")+
  ggtitle("Distribution of Resting Blood Pressure Readings")
BP_distribution 

describe(heart_dataframe$RestingBP)
stat.desc(heart_dataframe$RestingBP, basic = FALSE, norm = TRUE)
shapiro.test(heart_dataframe$RestingBP)

#log transformation to correct skew
log_RBP <- log(heart_dataframe$RestingBP)
log_RBP_hist <- hist(log_RBP, main= "Distribution of Resting BP in mmHg")


#MAXIMUM HEART RATE 
HR_distribution <- ggplot(heart_dataframe, aes( x= heart_dataframe$MaxHR, fill = heart_dataframe$MaxHR))+
  geom_histogram(color = "Black", fill = "darkorchid1")+
  xlab("Maximum Heart Rate in bpm")+
  ylab("count")+
  ggtitle("Distribution of Maximum Heart Rate across database")
HR_distribution 

describe(heart_dataframe$MaxHR)
stat.desc(heart_dataframe$MaxHR, basic = FALSE, norm = TRUE)
shapiro.test(heart_dataframe$MaxHR)

#Data is slightly Negatively skewed. Majority of the subjects' MaxHR falls 125-150bpm and data is Leptokurtik with kurtosis of -4.6 i.e. Heavy tailed with values father from mean.  

#apply reverse score transformation, use sqrt to correct  for moderately skewed data  
max_MHR <-  max(heart_dataframe$MaxHR)  
all_maxHR <- heart_dataframe$MaxHR
sqrt_MaxHR <- sqrt((max_MHR +1) - all_maxHR)
rev_MHR_hist <- hist(sqrt_MaxHR)

#OLD PEAK 
Oldpeak_distribution <- ggplot(heart_dataframe, aes( x= heart_dataframe$Oldpeak, fill = heart_dataframe$Oldpeak))+
  geom_histogram(color = "Black", fill = "cadetblue")+
  xlab("Oldpeak - ST depression induced by exercise relative to rest")+
  ylab("count")+
  ggtitle("Distribution of ST depression induced by exercise relative to rest")
Oldpeak_distribution #Positively skewed data 


describe(heart_dataframe$Oldpeak)
stat.desc(heart_dataframe$Oldpeak, basic = FALSE, norm = TRUE)

shapiro.test(heart_dataframe$Oldpeak)  #confirms data is not normally distributed. 

#Inverse data to correct for severe positive skew 
inv_oldpeak <- 1/(heart_dataframe$Oldpeak) 
hist(inv_oldpeak)
```

#Chunk 7: Characterizing distributions of FACTOR variables   
Bar plots used for factor variables and Histograms for continuous variables. 
```{r}


#Sex
gender_distribution <- ggplot(heart_dataframe, aes( x= heart_dataframe$Sex, fill = heart_dataframe$Sex))+
  geom_bar()+
  xlab("Gender")+
  ylab("count")+
  ggtitle("Distribution of Gender")+
  scale_fill_discrete(name = "Gender", labels = c("Female","Male"))
gender_distribution
#Data set contains significantly higher number of males(700) compared to females (200)

#Chest Pain Types
CP_distribution <- ggplot(heart_dataframe, aes( x= heart_dataframe$ChestPainType, fill = heart_dataframe$ChestPainType))+
  geom_bar()+
  xlab("Types of Chest Pain")+
  ylab("Count")+
  ggtitle("Distribution of Types of Chest Pain")+
  scale_fill_discrete(name = "Types of Chest Pain", labels = c("Asymptomatic", "Atypica", "Non-Anginal", "Typical"))
CP_distribution

# percent distribution of chest pain types 
cp_table <- table(heart_dataframe$ChestPainType)
percent_cp <- round(cp_table/sum(cp_table) *100)
labels1 <- paste(names(cp_table), percent_cp)
labels2 <- paste(labels1, "%", sep = "")
pie(cp_table, labels = labels2, col = c("azure1", "azure2", "azure3", "azure4"), main = "Distribution of types of chest pain within heart dataset" ) 

#Atypical Angina is the most observed 

#Fasting blood sugar 
BS_distribution <- ggplot(heart_dataframe, aes( x= heart_dataframe$FastingBS, fill = heart_dataframe$FastingBS))+
  geom_bar()+
  xlab("Fasting Blood Sugar Levels in mg/dl")+
  ylab("count")+
  ggtitle("Distribution of Fasting Blood Sugar Levels")+
  scale_fill_discrete(name = "Blood Sugar Levels", labels = c(">120 mg/dl","<120 mg/dl"))
BS_distribution

#Resting ECG
ECG_distribution <- ggplot(heart_dataframe, aes( x= heart_dataframe$RestingECG, fill = heart_dataframe$RestingECG))+
  geom_bar()+
  xlab("Resting ECG Results")+
  ylab("count")+
  ggtitle("Distribution of Resting ECG Results")+
  scale_fill_discrete(name = "ECG Results", labels = c("Normal", "ST", "LVH"))
ECG_distribution


#Exercise induced angina
Exangina_distribution <- ggplot(heart_dataframe, aes( x= heart_dataframe$ExerciseAngina, fill = heart_dataframe$ExerciseAngina))+
  geom_bar()+
  xlab("presence or absence of exercise induced angina ")+
  ylab("count")+
  ggtitle("Presence or Absence of Exercise Induced Angina")+
  scale_fill_discrete(name = "Exercise Induced Angina", labels = c("Absence","Presence"))
Exangina_distribution

#ST Slope
ST_distribution <- ggplot(heart_dataframe, aes( x= heart_dataframe$ST_Slope, fill = heart_dataframe$ST_Slope))+
  geom_bar()+
  xlab("ST Slope nature")+
  ylab("count")+
  ggtitle("Distribution of nature of the ST Slopes")+
  scale_fill_discrete(name = "ST Slopes", labels = c("Down", "Flat", "Up"))
ST_distribution

#Heart disease 
heartdisease_distribution <- ggplot(heart_dataframe, aes( x= heart_dataframe$HeartDisease, fill = heart_dataframe$HeartDisease))+
  geom_bar()+
  xlab("Heart Disease")+
  ylab("count")+
  ggtitle("Presence and absence of heart disease")+
  scale_fill_discrete(name = "Heart Disease", labels = c("Absence", "presence"))
heartdisease_distribution
prop.table(table(heart_dataframe$HeartDisease)) 

#Within the data set ~55.3% have heart disease and ~44.7% do not. Which is nearly a balanced dataset. 
```



#Correlation Matrix of only numeric varibales by subsetting heart_dataframe
```{r}
heart_numeric <- select_if(heart_dataframe, is.numeric)
heart_numeric
heart_numcor <- cor(heart_numeric, use = "complete")
heart_numcor
corrplot(heart_numcor, method = "circle")
```




#Data conversion to all numeric to obtain a complete correlation matrix and correlation plot 
```{r}
heart_dfnum <- heart_dataframe

#ST Slope
heart_dfnum$ST_Slope[heart_dfnum$ST_Slope == "2"] <- "0"
heart_dfnum$ST_Slope[heart_dfnum$ST_Slope == "1"] <- "1"
heart_dfnum$ST_Slope[heart_dfnum$ST_Slope == "3"] <- "2"
heart_dfnum$ST_Slope <- as.numeric(heart_dfnum$ST_Slope)

#sex
heart_dfnum$Sex[heart_dfnum$Sex == "M"] <- "0"
heart_dfnum$Sex[heart_dfnum$Sex == "F"] <- "1"
heart_dfnum$Sex <- as.numeric (heart_dfnum$Sex)


#ChestPainType
heart_dfnum$ChestPainType[heart_dfnum$ChestPainType == "TA"] <- "0"
heart_dfnum$ChestPainType[heart_dfnum$ChestPainType == "ATA"] <- "1"
heart_dfnum$ChestPainType[heart_dfnum$ChestPainType == "NAP"] <- "2"
heart_dfnum$ChestPainType[heart_dfnum$ChestPainType == "ASY"] <- "3"
heart_dfnum$ChestPainType <- as.numeric(heart_dfnum$ChestPainType)


#FastingBS 
#heart_dfnum$FastingBS[heart_dfnum$FastingBS == 0] <- "Low  (<120 mg/dl)"
#heart_dfnum$FastingBS[heart_dfnum$FastingBS == 1] <- "High (>120 mg/dl)"
heart_dfnum$FastingBS <- as.numeric(heart_dfnum$FastingBS)

#RestingECG
heart_dfnum$RestingECG[heart_dfnum$RestingECG == "Normal"] <- "0"
heart_dfnum$RestingECG[heart_dfnum$RestingECG == "ST"] <- "1"
heart_dfnum$RestingECG[heart_dfnum$RestingECG == "LVH"] <- "2"
heart_dfnum$RestingECG <- as.numeric(heart_dfnum$RestingECG)

#Exercise induced angina
heart_dfnum$ExerciseAngina[heart_dfnum$ExerciseAngina == "N"] <-"0"
heart_dfnum$ExerciseAngina[heart_dfnum$ExerciseAngina == "Y"] <- "1"
heart_dfnum$ExerciseAngina <- as.numeric(heart_dfnum$ExerciseAngina)


#Heart Disease
#heart_dfnum$HeartDisease[heart_dfnum$HeartDisease == "0"] <- "Health"
#heart_dfnum$HeartDisease[heart_dfnum$HeartDisease == "1"] <- "Heart Disease"
heart_dfnum$HeartDisease <- as.numeric(heart_dfnum$HeartDisease)

head(heart_dfnum,20)
summary(heart_dfnum)
str(heart_dfnum)

heart_cor <- cor(heart_dfnum, use = "complete.obs")
heart_cor
corrplot(heart_cor, method = "square")
```




#Correlation graphs: Age and Lab Values VS Heart Disease 
```{r}
#Between Heart Disease and Age 
age_HD <- ggplot(heart_dataframe, aes(x = Age, fill = HeartDisease, color = HeartDisease))+
          geom_histogram(binwidth = 1, color = "black") +
          facet_wrap(vars(HeartDisease))+
          xlab("Age in Years")+
          ylab("Frequency of presence or absence of Heart Disease")+
          ggtitle("Distribution of Heart Disease in relation to Age")
age_HD
#Histogram plots for presence Vs absence(Health) of heart disease have different distributions. 
#1. The distribution of presence of heart disease is negatively skewed.
#2. The distribution of absence of heart disease appears to be normally distributed. 
#3. Hence we can conclude that heart disease is more prevalent in older population compared to younger. 

#Between Resting blood pressure and presence/absence of heart disease
RBP_HD <- ggplot(heart_dataframe, aes( x = RestingBP, fill = HeartDisease))+
          geom_histogram()+
          xlab("Resting Blood Pressure in mmhg")+
          ylab(" Heart Disease")
# There does not appear to be a very strong relationship between resting BP and Presence and absence of heart disease as the median (middle 50%) of values for both plots are very similar. 
RBP_HD

CHL_HD <- ggplot(heart_dataframe, aes( x = Cholesterol,  fill = HeartDisease))+
          geom_histogram()+
          xlab("Serum Cholesterol Levels in mg/dl")+
          ylab("Heart Disease")
CHL_HD
#Similarly, there does not appear to be a very strong relationship between Serum Cholesterol and Presence and absence of heart disease as the median (middle 50%) of values for both plots are very similar. 

#Relationship between max HR achieved during exercise and presence and absence of heart disease 
MHR_HD <- ggplot(heart_dataframe, aes( x = MaxHR, fill = HeartDisease))+
          geom_histogram()+
          xlab("Maximum HR during exercise in bpm")+
          ylab("Heart Disease")
MHR_HD
#Max HR is the HR per minute reached during strenuous exercise. 
#There is a strong relationship between Max HR induced during exercise and presence and absence of heart disease. Subjects without heart disease are able to achieve a higher Max HR overall compared to subjects with heart disease. 

#Between Fasting blood sugar levels and presence/absence of heart disease
FBS_HD <- ggplot(heart_dataframe, aes(x = FastingBS, fill = HeartDisease))+
          geom_bar(position = "fill") +
          xlab("Fasting Blood Sugar levles in mgdl")+
          ylab("Frequency of presence or absence of Heart Disease")+
          ggtitle("Relationship between Fasting Blood Sugar Levels and Heart Disease")
FBS_HD
#Barplot above shows comparison between fasting blood sugar levels and presence or absence of heart disease. 
# Proportions in the plot indicate that there exists a relationship between fasting blood sugar levels and heart disease. 
# Fasting blood sugar levels of >120mg/dl (high) have increased rate of presence of heart disease compared to subjects with fasting blood sugar levels of <120mg/dl (low)

```


#Correlation: Cardiovascular events and Heart Disease 
```{r}
#Between Exercise induced angina and presence and absence of heart disease
ExAng_HD <- FBS_HD <- ggplot(heart_dataframe, aes(x = ExerciseAngina, fill = HeartDisease))+
          geom_bar(position = "fill") +
          xlab("Presence or Absence of exercise induced angina")+
          ylab("Heart Disease")+
          ggtitle("Relationship between Exercise Induced Angina and Heart Disease")
ExAng_HD
#Barplot above shows relationship between presence or absence of exercise induced angina Vs that of heart disease
# Proportions in the plot indicate that there exists a relationship between the two. 
# Rate of presence of exercise induced angina is significantly higher in subjects with heart disease compared to those with no heart disease (i.e. Health)

#Between ST segment depression induced by exercise and Heart Disease 
#Note: ST segment depression less than 0.5 mm is accepted in all leads. ST segment depression 0.5 mm or more is considered pathological. 
Oldpeak_HD <- ggplot(heart_dataframe, aes(x = Oldpeak, fill = HeartDisease, color = HeartDisease))+
          geom_histogram(binwidth = 0.5, color = "black") +
          facet_wrap(vars(HeartDisease))+
          xlab("ST segment depression values in mm")+
          ylab(" Heart Disease")+
          ggtitle("ST depression induced by exercise and presence and absence of heart disease")
Oldpeak_HD
#Histrograms below show the relationship between distribution of ST segment depression induced by exercise and presence and absence of heart disease. 
#Note: ST segment depression less than 0.5 mm is accepted in all leads. ST segment depression 0.5 mm or more is considered pathological. 
#ST segment depression distribution in subjects without heart disease(Health) is positively skewed with majority subjects at 0.0 depression. 
#However, the distribution in subjects with heart disease shows significant number of subjects with ST segment depression >0.5 which is considered pathological. 

#Distribution of chest pain types in presence vs absence of heart disease
CPT_HD <- ggplot(heart_dataframe, aes( x = HeartDisease, fill = ChestPainType))+
  geom_bar(position = "dodge")+
  xlab(" Heart Disease")+
  ylab("Type of Chest Pain")+
  ggtitle("Distribution of chest pain types in presence vs absence of heart disease")
CPT_HD


```







#Logistical Regression
```{r}
#MHR_HD_fit <- lm( HeartDisease ~ MaxHR, data = heart_dataframe) 
#MHR_HD_fit
#summary(MHR_HD_fit)
# y = 148 -20.50*x
#F statistic = MSM/MSR = 174.9 
#Yes, the result obtained is statistically significant. This can be said because p value (< 2.2e-16) is less than alpha 0.05. Hence we can reject the null hypothesis that there is no correlation between MaxHR and presence and absence of heart disease. Which allows us to accept the Alternative Hypothesis that a correlation exists between insulin and fatty acid levels. Due to above reasons we can say that the probability that we obtain a regression line that fits this well is NOT by  random chance. 

#RBP_HD_fit <- lm( HeartDisease ~ RestingBP, data = heart_dataframe) 
#RBP_HD_fit
#summary(RBP_HD_fit)
```




